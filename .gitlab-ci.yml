# Official image for Hashicorp's Terraform. It uses light image which is Alpine
# based as it is much lighter.
#
# Entrypoint is also needed as image by default set `terraform` binary as an
# entrypoint.
image:
  name: python:3.7
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'


cache:
  paths:
    - .terraform

before_script:
  - apt-get update -qy
  - apk --no-cache add jq
  - apk add --update nodejs nodejs-npm
  - npm install -g aws-cdk
  - apt-get install -y python-dev python-pip
  - mkdir -p ./.aws
  - echo $AWS_SERVICE_ACCOUNT | base64 -d > ./.aws/config
  - python -m pip install awscli boto3


stages:
  - validate
  - build
  - test
  - deploy
  - decommution

validate:
  stage: validate
  script:
    - pip install -r requirements.txt
    - cdk synth

plan:
  stage: build
  script:
    - cdk synth


# Separate apply job for manual launching Terraform as it can be destructive
# action.
apply:
  stage: deploy
  environment:
    name: production
  script:
    - cdk deploy

  dependencies:
    - plan
  when: manual
  only:
    - develop

destroy:
  stage: decommution
  environment:
    name: production
  script:
    - cdk destroy
  dependencies:
    - plan
  when: manual
  only:
    - develop

